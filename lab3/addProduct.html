<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <title>Add Product </title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="style.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
</head>

<body>

  <nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
      <a class="navbar-brand" href="./shopping.html">MoreBuy</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
        aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <a class="nav-link" aria-current="page" href="shopping.html">Home</a>
          <a class="nav-link" href="cart.html">Cart</a>
          <a class="nav-link active" href="addProduct.html">Product Management</a>
        </div>
      </div>
    </div>
  </nav>


  <div class="container">
    <div class="container-sm border rounded m-3 p-3">

      <h2>Add an Product</h2>
      <form id="form">
        <div class="mb-3">
          <label for="product_title" class="form-label">Product Title</label>
          <input required type="text" class="form-control" name="title" id="product_title">
        </div>
        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" checked type="radio" name="img_type" id="img_url_radio">
            <label class="form-check-label" for="img_url_radio">
              Image URL
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="img_type" id="img_upload_radio">
            <label class="form-check-label" for="img_upload_radio">
              Image Upload
            </label>
          </div>
          <label for="product_img" class="form-label">Product Image</label>
          <input type="text" placeholder="Enter image URL" name="image" class="form-control" id="product_img">
          <input type="file" class="form-control" id="file" name="image" />
        </div>
        <div class="mb-3">
          <label for="product_des" class="form-label">Product Description</label>
          <textarea required type="text" class="form-control" name="desc" id="product_des"></textarea>
        </div>
        <div class="mb-3">
          <label for="product_price" class="form-label">Product Price</label>
          <input required type="number" class="form-control" name="price" id="product_price">
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>
    <div class="container" id="products__wrapper"></div>
  </div>
</body>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"
  integrity="sha384-zYPOMqeu1DAVkHiLqWBUTcbYfZ8osu1Nd6Z89ify25QV9guujx43ITvfi12/QExE" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.min.js"
  integrity="sha384-Y4oOpwW3duJdCWv5ly8SCFYWqFDsfob/3GkgExXKV4idmbt98QcxXYs9UoXAB7BZ" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>

<script>

  const imgUrl = document.getElementById("product_img");
  const imgFile = document.getElementById("file");
  const imgUploadRadio = document.getElementById("img_upload_radio");
  const imgURLRadio = document.getElementById("img_url_radio");




  imgFile.style.display = 'none';


  imgUploadRadio.addEventListener("click", (e) => {
    if (imgUploadRadio.checked) {
      imgFile.style.display = 'block';
      imgUrl.style.display = 'none'
    }

  })

  imgURLRadio.addEventListener("click", (e) => {

    if (imgURLRadio.checked) {
      imgFile.style.display = 'none';
      imgUrl.style.display = 'block'
    }

  })
  const form = document.getElementById("form");

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    new FormData(form);
  })


  form.addEventListener("formdata", async (e) => {
    let {formData} = e;

    let image = formData.get("image")
    let file = document.getElementById("file").files[0];
    let base64;
    if (file) {
      image = await convertBase64(file);
    }
    const product = {
      title: formData.get("title"),
      image,
      description: formData.get("desc"),
      price: Number(formData.get("price")),
    }

    console.log(product);
    const products = JSON.parse(localStorage.getItem("products")) || []

    products.push({id: products.length + 1, ...product})
    localStorage.setItem("products", JSON.stringify(products))
    location.reload();

  })


  const convertBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const fileReader = new FileReader();
      fileReader.readAsDataURL(file);

      fileReader.onload = () => {
        resolve(fileReader.result);
      };

      fileReader.onerror = (error) => {
        reject(error);
      };
    });
  };


  const generateProducts = (products) => {
    let productsString = "";
    products.forEach(({title, image, description, price, id}) => {
      productsString += `<div class="product__card" style="width: 18rem;">
      <img src="${image}" class="product__image"
    alt="${title}">
      <div class="product__body">
      <div class="details">
      <h3 class="card-text">${title}</h3>
      <p class="card-text">${description}</p>
      <p class="card-text">&#8377; ${price}</p>
      </div>
      <button class="btn btn-primary mt-3" id="remove_btn" data-pid=${id}>Remove</button>
      </div>
      </div>
    `

    })

    return productsString;
  }

  const loadProductsFromJSON = async () => {
    const res = await fetch("./products.json");
    const products = await res.json();
    localStorage.setItem("products", JSON.stringify(products));
    location.reload();

  }
  const productsWrapper = document.getElementById("products__wrapper");
  products = JSON.parse(localStorage.getItem("products")) || [];
  if (products.length == 0) {
    productsWrapper.innerHTML = `<div><h3>Load Products</h3><button onclick="loadProductsFromJSON()" class="btn btn-primary">Load</button>`
  }
  else {
    productsWrapper.innerHTML = generateProducts(products);
  }

  const removeItem = (id) => {
    const products = JSON.parse(localStorage.getItem("products")) || [];
    let updatedProducts = products.filter(c => c.id != id);
    localStorage.setItem("products", JSON.stringify(updatedProducts));
    location.reload();
  }


  const removeFromCartBtn = document.querySelectorAll("#remove_btn");
  removeFromCartBtn.forEach(b => b.addEventListener("click", (e) => {
    removeItem(Number(e.target.getAttribute("data-pid")))
  }));

</script>

</html>
